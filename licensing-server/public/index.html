<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CoreBit License Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
    
    /* Login Page */
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #1e293b; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; }
    .login-box h1 { font-size: 24px; margin-bottom: 8px; color: #f8fafc; }
    .login-box p { color: #94a3b8; margin-bottom: 24px; }
    
    /* Dashboard */
    .dashboard { display: none; }
    .header { background: #1e293b; border-bottom: 1px solid #334155; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 20px; color: #f8fafc; display: flex; align-items: center; gap: 8px; }
    .header h1 span { color: #22c55e; }
    .logout-btn { background: transparent; border: 1px solid #475569; color: #94a3b8; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #334155; color: #e2e8f0; }
    
    .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    
    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #1e293b; padding: 20px; border-radius: 8px; border: 1px solid #334155; }
    .stat-card .label { color: #94a3b8; font-size: 14px; margin-bottom: 4px; }
    .stat-card .value { font-size: 28px; font-weight: 600; color: #f8fafc; }
    .stat-card.active .value { color: #22c55e; }
    .stat-card.pending .value { color: #f59e0b; }
    
    /* Actions */
    .actions { display: flex; gap: 12px; margin-bottom: 24px; }
    
    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; color: #94a3b8; font-size: 14px; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-ghost { background: transparent; border: 1px solid #475569; color: #94a3b8; }
    .btn-ghost:hover { background: #334155; color: #e2e8f0; }
    
    /* Table */
    .table-container { background: #1e293b; border-radius: 8px; border: 1px solid #334155; overflow: hidden; }
    .table-header { padding: 16px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .table-header h2 { font-size: 16px; color: #f8fafc; }
    .search-input { width: 250px; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #334155; }
    th { background: #0f172a; color: #94a3b8; font-weight: 500; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { font-size: 14px; }
    tr:hover { background: #0f172a40; }
    tr:last-child td { border-bottom: none; }
    
    .license-key { font-family: monospace; color: #22c55e; font-size: 13px; }
    .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .status.active { background: #22c55e20; color: #22c55e; }
    .status.pending { background: #f59e0b20; color: #f59e0b; }
    .status.expired { background: #ef444420; color: #ef4444; }
    
    .action-btns { display: flex; gap: 8px; }
    .action-btn { padding: 6px 10px; font-size: 12px; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal-overlay.active { display: flex; }
    .modal { background: #1e293b; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 18px; color: #f8fafc; }
    .modal-close { background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 12px; }
    
    /* Utilities */
    .text-muted { color: #64748b; }
    .text-sm { font-size: 13px; }
    .mt-2 { margin-top: 8px; }
    .hidden { display: none; }
    
    /* Error/Success Messages */
    .message { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
    .message.error { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }
    .message.success { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
    .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
    
    /* Activation History */
    .activations-list { max-height: 300px; overflow-y: auto; }
    .activation-item { padding: 12px; background: #0f172a; border-radius: 6px; margin-bottom: 8px; font-size: 13px; }
    .activation-item .fingerprint { font-family: monospace; color: #60a5fa; word-break: break-all; }
    .activation-item .meta { color: #64748b; margin-top: 4px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid #334155; }
    .tab { padding: 12px 20px; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .tab:hover { color: #e2e8f0; }
    .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Release Card */
    .release-card { background: #1e293b; border-radius: 8px; border: 1px solid #334155; padding: 20px; margin-bottom: 16px; }
    .release-card .version { font-size: 18px; font-weight: 600; color: #22c55e; margin-bottom: 8px; }
    .release-card .meta-row { display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 12px; }
    .release-card .meta-item { display: flex; flex-direction: column; }
    .release-card .meta-label { font-size: 12px; color: #64748b; text-transform: uppercase; }
    .release-card .meta-value { font-size: 14px; color: #e2e8f0; }
    .release-card .changelog { background: #0f172a; padding: 12px; border-radius: 6px; font-size: 13px; color: #94a3b8; white-space: pre-wrap; margin-top: 12px; }
    .release-card .actions { display: flex; gap: 8px; margin-top: 16px; }
    
    /* File upload */
    .file-upload { border: 2px dashed #334155; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: border-color 0.2s; }
    .file-upload:hover { border-color: #3b82f6; }
    .file-upload.dragover { border-color: #22c55e; background: #22c55e10; }
    .file-upload input[type="file"] { display: none; }
    .file-upload .label { color: #94a3b8; margin-bottom: 8px; }
    .file-upload .selected { color: #22c55e; font-family: monospace; }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1>CoreBit License Admin</h1>
      <p>Sign in to manage licenses</p>
      <div id="loginError" class="message error hidden"></div>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header class="header">
      <h1><span>CoreBit</span> License Admin</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </header>
    
    <main class="main">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('licenses')">Licenses</button>
        <button class="tab" onclick="switchTab('releases')">Releases</button>
      </div>
      
      <!-- Licenses Tab -->
      <div id="licensesTab" class="tab-content active">
        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <div class="label">Total Licenses</div>
            <div class="value" id="totalLicenses">0</div>
          </div>
          <div class="stat-card active">
            <div class="label">Activated</div>
            <div class="value" id="activatedLicenses">0</div>
          </div>
          <div class="stat-card pending">
            <div class="label">Pending Activation</div>
            <div class="value" id="pendingLicenses">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Pro Licenses</div>
            <div class="value" id="proLicenses">0</div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="actions">
          <button class="btn btn-success" onclick="openIssueModal()">+ Issue New License</button>
          <button class="btn btn-ghost" onclick="loadLicenses()">Refresh</button>
        </div>
        
        <!-- Licenses Table -->
        <div class="table-container">
          <div class="table-header">
            <h2>All Licenses</h2>
            <input type="text" class="search-input" placeholder="Search by key, email, or name..." id="searchInput" oninput="filterLicenses()">
          </div>
          <table>
            <thead>
              <tr>
                <th>License Key</th>
                <th>Customer</th>
                <th>Tier</th>
                <th>Status</th>
                <th>Updates Until</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="licensesTable">
            </tbody>
          </table>
          <div id="emptyState" class="empty-state hidden">
            <h3>No licenses found</h3>
            <p>Issue your first license to get started</p>
          </div>
        </div>
      </div>
      
      <!-- Releases Tab -->
      <div id="releasesTab" class="tab-content">
        <!-- Release Stats -->
        <div class="stats">
          <div class="stat-card">
            <div class="label">Total Releases</div>
            <div class="value" id="totalReleases">0</div>
          </div>
          <div class="stat-card active">
            <div class="label">Latest Version</div>
            <div class="value" id="latestVersion">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Downloads</div>
            <div class="value" id="totalDownloads">0</div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="actions">
          <button class="btn btn-success" onclick="openUploadModal()">+ Upload New Release</button>
          <button class="btn btn-ghost" onclick="loadReleases()">Refresh</button>
        </div>
        
        <!-- Releases List -->
        <div id="releasesList"></div>
        <div id="releasesEmptyState" class="empty-state hidden">
          <h3>No releases yet</h3>
          <p>Upload your first release to enable updates</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Issue License Modal -->
  <div id="issueModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Issue New License</h3>
        <button class="modal-close" onclick="closeIssueModal()">&times;</button>
      </div>
      <form id="issueForm" onsubmit="issueLicense(event)">
        <div class="modal-body">
          <div id="issueError" class="message error hidden"></div>
          <div class="form-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" name="customerName" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label for="customerEmail">Customer Email</label>
            <input type="email" id="customerEmail" name="customerEmail" placeholder="john@example.com">
          </div>
          <div class="form-group">
            <label for="tier">Tier</label>
            <select id="tier" name="tier">
              <option value="pro">Pro (Unlimited Devices)</option>
              <option value="free">Free (10 Devices)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="yearsOfUpdates">Years of Updates</label>
            <select id="yearsOfUpdates" name="yearsOfUpdates">
              <option value="1">1 Year</option>
              <option value="2">2 Years</option>
              <option value="3">3 Years</option>
              <option value="5">5 Years</option>
            </select>
          </div>
          <div class="form-group">
            <label for="notes">Notes (internal)</label>
            <textarea id="notes" name="notes" rows="2" placeholder="Optional internal notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeIssueModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Issue License</button>
        </div>
      </form>
    </div>
  </div>

  <!-- License Details Modal -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>License Details</h3>
        <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="licenseDetails"></div>
        <h4 style="margin-top: 20px; margin-bottom: 12px; color: #94a3b8;">Activation History</h4>
        <div id="activationHistory" class="activations-list"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeDetailsModal()">Close</button>
        <button type="button" class="btn btn-danger" id="releaseBtn" onclick="releaseLicense()">Release Activation</button>
      </div>
    </div>
  </div>

  <!-- Release Confirmation Modal -->
  <div id="releaseModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Release License Activation</h3>
        <button class="modal-close" onclick="closeReleaseModal()">&times;</button>
      </div>
      <form id="releaseForm" onsubmit="confirmRelease(event)">
        <div class="modal-body">
          <p style="margin-bottom: 16px;">This will clear the server fingerprint, allowing the license to be activated on a new server.</p>
          <div id="releaseError" class="message error hidden"></div>
          <div class="form-group">
            <label for="releaseReason">Reason for release</label>
            <textarea id="releaseReason" name="reason" rows="2" placeholder="e.g., Customer migrated to new server" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeReleaseModal()">Cancel</button>
          <button type="submit" class="btn btn-danger">Confirm Release</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal for newly issued license -->
  <div id="successModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>License Issued Successfully</h3>
        <button class="modal-close" onclick="closeSuccessModal()">&times;</button>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="background: #22c55e20; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; margin: 20px 0;">
          <p style="color: #94a3b8; margin-bottom: 8px;">License Key</p>
          <div id="newLicenseKey" style="font-family: monospace; font-size: 20px; color: #22c55e; letter-spacing: 2px;"></div>
        </div>
        <button class="btn btn-primary" onclick="copyNewLicense()">Copy to Clipboard</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeSuccessModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Upload Release Modal -->
  <div id="uploadModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Upload New Release</h3>
        <button class="modal-close" onclick="closeUploadModal()">&times;</button>
      </div>
      <form id="uploadForm" onsubmit="uploadRelease(event)">
        <div class="modal-body">
          <div id="uploadError" class="message error hidden"></div>
          <div class="form-group">
            <label for="releaseVersion">Version *</label>
            <input type="text" id="releaseVersion" name="version" placeholder="1.0.0" required pattern="[0-9]+\.[0-9]+\.[0-9]+.*">
            <small class="text-muted">Semantic versioning (e.g., 1.0.0, 2.1.3-beta)</small>
          </div>
          <div class="form-group">
            <label for="releaseChannel">Channel</label>
            <select id="releaseChannel" name="channel">
              <option value="stable">Stable</option>
              <option value="beta">Beta</option>
            </select>
          </div>
          <div class="form-group">
            <label for="releaseChangelog">Changelog</label>
            <textarea id="releaseChangelog" name="changelog" rows="4" placeholder="- Fixed bug X&#10;- Added feature Y&#10;- Improved performance"></textarea>
          </div>
          <div class="form-group">
            <label>Release File *</label>
            <div class="file-upload" id="fileUploadArea" onclick="document.getElementById('releaseFile').click()">
              <input type="file" id="releaseFile" name="file" accept=".zip,.tar.gz,.tgz" required>
              <div class="label">Click or drag to upload .zip or .tar.gz</div>
              <div class="selected" id="selectedFileName"></div>
            </div>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="isPrerelease" name="isPrerelease" style="width: auto;">
              Mark as pre-release (won't show in update checks)
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" onclick="closeUploadModal()">Cancel</button>
          <button type="submit" class="btn btn-success" id="uploadBtn">Upload Release</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Release Confirmation Modal -->
  <div id="deleteReleaseModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Delete Release</h3>
        <button class="modal-close" onclick="closeDeleteReleaseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete version <strong id="deleteVersion"></strong>?</p>
        <p class="text-muted mt-2">This will remove the release file and cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeDeleteReleaseModal()">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteRelease()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let licenses = [];
    let currentLicenseKey = null;

    // Check session on load
    document.addEventListener('DOMContentLoaded', checkSession);

    async function checkSession() {
      try {
        const res = await fetch('/api/admin/session', { credentials: 'include' });
        if (res.ok) {
          showDashboard();
          loadLicenses();
        } else {
          showLogin();
        }
      } catch (e) {
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('dashboard').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorEl = document.getElementById('loginError');
      
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'include'
        });
        
        if (res.ok) {
          errorEl.classList.add('hidden');
          showDashboard();
          loadLicenses();
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Invalid credentials';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.remove('hidden');
      }
    });

    async function logout() {
      await fetch('/api/admin/logout', { method: 'POST', credentials: 'include' });
      showLogin();
    }

    // Load licenses
    async function loadLicenses() {
      try {
        const res = await fetch('/api/admin/licenses', { credentials: 'include' });
        if (res.status === 401) {
          showLogin();
          return;
        }
        licenses = await res.json();
        renderLicenses(licenses);
        updateStats();
      } catch (e) {
        console.error('Failed to load licenses:', e);
      }
    }

    function updateStats() {
      const total = licenses.length;
      const activated = licenses.filter(l => l.fingerprint).length;
      const pending = licenses.filter(l => !l.fingerprint).length;
      const pro = licenses.filter(l => l.tier === 'pro').length;
      
      document.getElementById('totalLicenses').textContent = total;
      document.getElementById('activatedLicenses').textContent = activated;
      document.getElementById('pendingLicenses').textContent = pending;
      document.getElementById('proLicenses').textContent = pro;
    }

    function renderLicenses(data) {
      const tbody = document.getElementById('licensesTable');
      const emptyState = document.getElementById('emptyState');
      
      if (data.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      tbody.innerHTML = data.map(license => {
        const isExpired = new Date(license.updates_valid_until) < new Date();
        const statusClass = license.fingerprint ? 'active' : 'pending';
        const statusText = license.fingerprint ? 'Activated' : 'Pending';
        
        const isStripe = license.stripe_payment_intent || license.stripe_session_id;
        
        return `
          <tr>
            <td>
              <span class="license-key">${license.license_key}</span>
              ${isStripe ? '<span style="display: inline-block; margin-left: 6px; padding: 2px 6px; background: #635bff30; color: #a5b4fc; border-radius: 4px; font-size: 10px; vertical-align: middle;">STRIPE</span>' : ''}
            </td>
            <td>
              <div>${license.customer_name || '<span class="text-muted">-</span>'}</div>
              <div class="text-sm text-muted">${license.customer_email || ''}</div>
            </td>
            <td>${license.tier.toUpperCase()}</td>
            <td><span class="status ${statusClass}">${statusText}</span></td>
            <td>
              <span class="${isExpired ? 'text-muted' : ''}">${formatDate(license.updates_valid_until)}</span>
              ${isExpired ? '<span class="status expired" style="margin-left: 4px;">Expired</span>' : ''}
            </td>
            <td class="text-sm text-muted">${formatDate(license.created_at)}</td>
            <td>
              <div class="action-btns">
                <button class="btn btn-ghost action-btn" onclick="viewDetails('${license.license_key}')">Details</button>
                ${license.fingerprint ? `<button class="btn btn-danger action-btn" onclick="openReleaseModal('${license.license_key}')">Release</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterLicenses() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const filtered = licenses.filter(l => 
        l.license_key.toLowerCase().includes(query) ||
        (l.customer_name || '').toLowerCase().includes(query) ||
        (l.customer_email || '').toLowerCase().includes(query)
      );
      renderLicenses(filtered);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    // Issue License Modal
    function openIssueModal() {
      document.getElementById('issueModal').classList.add('active');
      document.getElementById('issueForm').reset();
      document.getElementById('issueError').classList.add('hidden');
    }

    function closeIssueModal() {
      document.getElementById('issueModal').classList.remove('active');
    }

    async function issueLicense(e) {
      e.preventDefault();
      const errorEl = document.getElementById('issueError');
      
      const formData = {
        customerName: document.getElementById('customerName').value,
        customerEmail: document.getElementById('customerEmail').value,
        tier: document.getElementById('tier').value,
        yearsOfUpdates: parseInt(document.getElementById('yearsOfUpdates').value),
        notes: document.getElementById('notes').value,
        deviceLimit: document.getElementById('tier').value === 'free' ? 10 : null
      };
      
      try {
        const res = await fetch('/api/admin/licenses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
          credentials: 'include'
        });
        
        if (res.ok) {
          const data = await res.json();
          closeIssueModal();
          showSuccessModal(data.licenseKey);
          loadLicenses();
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Failed to issue license';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.remove('hidden');
      }
    }

    // Success Modal
    function showSuccessModal(licenseKey) {
      document.getElementById('newLicenseKey').textContent = licenseKey;
      document.getElementById('successModal').classList.add('active');
    }

    function closeSuccessModal() {
      document.getElementById('successModal').classList.remove('active');
    }

    function copyNewLicense() {
      const key = document.getElementById('newLicenseKey').textContent;
      navigator.clipboard.writeText(key);
    }

    // Details Modal
    async function viewDetails(licenseKey) {
      currentLicenseKey = licenseKey;
      const license = licenses.find(l => l.license_key === licenseKey);
      
      const detailsHtml = `
        <div class="form-group">
          <label>License Key</label>
          <div class="license-key" style="font-size: 16px; padding: 8px 0;">${license.license_key}</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label>Customer Name</label>
            <div>${license.customer_name || '-'}</div>
          </div>
          <div class="form-group">
            <label>Customer Email</label>
            <div>${license.customer_email || '-'}</div>
          </div>
          <div class="form-group">
            <label>Tier</label>
            <div>${license.tier.toUpperCase()}</div>
          </div>
          <div class="form-group">
            <label>Device Limit</label>
            <div>${license.device_limit || 'Unlimited'}</div>
          </div>
          <div class="form-group">
            <label>Purchase Date</label>
            <div>${formatDate(license.purchase_date)}</div>
          </div>
          <div class="form-group">
            <label>Updates Valid Until</label>
            <div>${formatDate(license.updates_valid_until)}</div>
          </div>
        </div>
        ${license.fingerprint ? `
          <div class="form-group" style="margin-top: 16px;">
            <label>Activated Fingerprint</label>
            <div style="font-family: monospace; font-size: 12px; word-break: break-all; background: #0f172a; padding: 8px; border-radius: 4px;">${license.fingerprint}</div>
          </div>
        ` : '<div class="message" style="background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b40;">License not yet activated</div>'}
        ${license.notes ? `
          <div class="form-group" style="margin-top: 16px;">
            <label>Notes</label>
            <div class="text-muted">${license.notes}</div>
          </div>
        ` : ''}
        ${license.stripe_payment_intent || license.stripe_session_id ? `
          <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
            <label style="display: flex; align-items: center; gap: 6px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#635bff" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
              Stripe Payment
            </label>
            <div style="display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap;">
              ${license.stripe_payment_intent ? `
                <a href="https://dashboard.stripe.com/payments/${license.stripe_payment_intent}" 
                   target="_blank" rel="noopener" 
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #635bff20; color: #a5b4fc; border-radius: 6px; text-decoration: none; font-size: 13px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  View Payment
                </a>
              ` : ''}
              ${license.stripe_session_id ? `
                <a href="https://dashboard.stripe.com/checkout/sessions/${license.stripe_session_id}" 
                   target="_blank" rel="noopener"
                   style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #635bff20; color: #a5b4fc; border-radius: 6px; text-decoration: none; font-size: 13px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  View Checkout Session
                </a>
              ` : ''}
            </div>
            <div class="text-muted text-sm mt-2">Invoice available in Stripe Dashboard under the payment details</div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('licenseDetails').innerHTML = detailsHtml;
      document.getElementById('releaseBtn').style.display = license.fingerprint ? 'inline-block' : 'none';
      
      // Load activation history
      try {
        const res = await fetch(`/api/admin/licenses/${licenseKey}/activations`, { credentials: 'include' });
        const activations = await res.json();
        
        if (activations.length === 0) {
          document.getElementById('activationHistory').innerHTML = '<div class="text-muted">No activation history</div>';
        } else {
          document.getElementById('activationHistory').innerHTML = activations.map(a => `
            <div class="activation-item">
              <div class="fingerprint">${a.fingerprint}</div>
              <div class="meta">${formatDate(a.activated_at)} from ${a.ip_address || 'Unknown IP'}</div>
            </div>
          `).join('');
        }
      } catch (e) {
        document.getElementById('activationHistory').innerHTML = '<div class="text-muted">Failed to load history</div>';
      }
      
      document.getElementById('detailsModal').classList.add('active');
    }

    function closeDetailsModal() {
      document.getElementById('detailsModal').classList.remove('active');
      currentLicenseKey = null;
    }

    function releaseLicense() {
      closeDetailsModal();
      openReleaseModal(currentLicenseKey);
    }

    // Release Modal
    function openReleaseModal(licenseKey) {
      currentLicenseKey = licenseKey;
      document.getElementById('releaseModal').classList.add('active');
      document.getElementById('releaseForm').reset();
      document.getElementById('releaseError').classList.add('hidden');
    }

    function closeReleaseModal() {
      document.getElementById('releaseModal').classList.remove('active');
      currentLicenseKey = null;
    }

    async function confirmRelease(e) {
      e.preventDefault();
      const reason = document.getElementById('releaseReason').value;
      const errorEl = document.getElementById('releaseError');
      
      try {
        const res = await fetch(`/api/admin/licenses/${currentLicenseKey}/release`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason }),
          credentials: 'include'
        });
        
        if (res.ok) {
          closeReleaseModal();
          loadLicenses();
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Failed to release license';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.remove('hidden');
      }
    }

    // ============== RELEASES TAB ==============
    let releases = [];
    let deleteReleaseVersion = null;

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
      document.getElementById(`${tab}Tab`).classList.add('active');
      
      if (tab === 'releases') {
        loadReleases();
      }
    }

    // Load releases
    async function loadReleases() {
      try {
        const res = await fetch('/api/admin/releases', { credentials: 'include' });
        if (res.status === 401) {
          showLogin();
          return;
        }
        releases = await res.json();
        renderReleases();
        updateReleaseStats();
      } catch (e) {
        console.error('Failed to load releases:', e);
      }
    }

    function updateReleaseStats() {
      const total = releases.length;
      const latest = releases.length > 0 ? releases[0].version : '-';
      const downloads = releases.reduce((sum, r) => sum + (r.download_count || 0), 0);
      
      document.getElementById('totalReleases').textContent = total;
      document.getElementById('latestVersion').textContent = latest;
      document.getElementById('totalDownloads').textContent = downloads;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function renderReleases() {
      const container = document.getElementById('releasesList');
      const emptyState = document.getElementById('releasesEmptyState');
      
      if (releases.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      container.innerHTML = releases.map((release, idx) => `
        <div class="release-card">
          <div class="version">
            v${release.version}
            ${release.is_prerelease ? '<span class="status pending" style="margin-left: 8px;">Pre-release</span>' : ''}
            ${idx === 0 ? '<span class="status active" style="margin-left: 8px;">Latest</span>' : ''}
          </div>
          <div class="meta-row">
            <div class="meta-item">
              <span class="meta-label">Build Date</span>
              <span class="meta-value">${formatDate(release.build_date)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Channel</span>
              <span class="meta-value">${release.channel}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">File</span>
              <span class="meta-value">${release.file_name} (${formatFileSize(release.file_size_bytes)})</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Downloads</span>
              <span class="meta-value">${release.download_count || 0}</span>
            </div>
          </div>
          ${release.changelog ? `<div class="changelog">${release.changelog}</div>` : ''}
          <div class="actions">
            <button class="btn btn-primary action-btn" onclick="downloadRelease('${release.version}')">Download</button>
            <button class="btn btn-ghost action-btn" onclick="copyChecksum('${release.sha256}')">Copy SHA256</button>
            <button class="btn btn-danger action-btn" onclick="openDeleteReleaseModal('${release.version}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function downloadRelease(version) {
      window.open(`/api/releases/${version}/download`, '_blank');
    }

    function copyChecksum(sha256) {
      navigator.clipboard.writeText(sha256);
      alert('SHA256 checksum copied to clipboard');
    }

    // Upload Modal
    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('active');
      document.getElementById('uploadForm').reset();
      document.getElementById('uploadError').classList.add('hidden');
      document.getElementById('selectedFileName').textContent = '';
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('uploadBtn').textContent = 'Upload Release';
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
    }

    // File upload handling
    document.getElementById('releaseFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('selectedFileName').textContent = file.name;
      }
    });

    // Drag and drop
    const uploadArea = document.getElementById('fileUploadArea');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('releaseFile').files = e.dataTransfer.files;
        document.getElementById('selectedFileName').textContent = file.name;
      }
    });

    async function uploadRelease(e) {
      e.preventDefault();
      const errorEl = document.getElementById('uploadError');
      const uploadBtn = document.getElementById('uploadBtn');
      
      const formData = new FormData();
      formData.append('version', document.getElementById('releaseVersion').value);
      formData.append('channel', document.getElementById('releaseChannel').value);
      formData.append('changelog', document.getElementById('releaseChangelog').value);
      formData.append('isPrerelease', document.getElementById('isPrerelease').checked);
      formData.append('buildDate', new Date().toISOString());
      formData.append('file', document.getElementById('releaseFile').files[0]);
      
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      
      try {
        const res = await fetch('/api/admin/releases', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        
        if (res.ok) {
          closeUploadModal();
          loadReleases();
        } else {
          const data = await res.json();
          errorEl.textContent = data.error || 'Failed to upload release';
          errorEl.classList.remove('hidden');
        }
      } catch (e) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.remove('hidden');
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Release';
      }
    }

    // Delete Release Modal
    function openDeleteReleaseModal(version) {
      deleteReleaseVersion = version;
      document.getElementById('deleteVersion').textContent = version;
      document.getElementById('deleteReleaseModal').classList.add('active');
    }

    function closeDeleteReleaseModal() {
      document.getElementById('deleteReleaseModal').classList.remove('active');
      deleteReleaseVersion = null;
    }

    async function confirmDeleteRelease() {
      if (!deleteReleaseVersion) return;
      
      try {
        const res = await fetch(`/api/admin/releases/${deleteReleaseVersion}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          closeDeleteReleaseModal();
          loadReleases();
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to delete release');
        }
      } catch (e) {
        alert('Connection error');
      }
    }
  </script>
</body>
</html>
